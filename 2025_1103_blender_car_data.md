# ì—°êµ¬ì‹¤ ìƒì„±ê¸°ë¡œ ìƒì„±ëœ blender terrain ì— ì£¼í–‰ ì‹œë®¬ë ˆì´ì…˜ (blender) ì ìš© ë° ê°€ìƒì„¼ì„œë¥¼ ì´ìš©í•œ ë°ì´í„° íšë“ ë°©ì•ˆ
## ëª©ì°¨
- terrain ì ìš©ì—ì„œì˜ ë¬¸ì œì 
- í•´ê²° ë°©ì•ˆ1(Convex_Hull ìœ ì§€)
- í•´ê²° ë°©ì•ˆ2(Mesh)
- ê°€ìƒì„¼ì„œ 
### ë¬¸ì œì 
#### ì—°êµ¬ì‹¤ ìƒì„±ê¸°ë¡œ ë°›ì€ ì‚°ì•…ì§€í˜•ì€ ê°€ìš´ë°ê°€ ì›€í‘¹ íŒ¨ì¸ ì§€í˜•
![](./ì´ë¯¸ì§€/p1mountain.png)
- ì§€í˜•ì˜ Shapeì„ Convex Hullë¡œ ì„¤ì •í•  ì‹œ ì§€ë©´ì˜ ì„¸ë°€í•œ ê°ë„ í•˜ë‚˜í•˜ë‚˜ê°€ ì „ë¶€ ê³„ì‚°ë˜ì–´ ìë™ì°¨ê°€ ì›€ì§ì´ì§„ ì•Šì•„ë„ ì—°ì‚°ëŸ‰ì„ ì•„ë‚„ ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆìŒ
- ë‹¤ë§Œ ì €ëŸ° ë¶„í™”êµ¬ë‚˜ ê³„ê³¡ê°™ì€ ì§€í˜•ì—ì„  Convex Hullì€ ì‚¬ìš© ë¶ˆê°€

ì˜ìƒ2

#### ì™œ ì´ëŸ° ì¼ì´?
- Convex_Hullì˜ Collider ëª¨ì–‘ ë•Œë¬¸
- ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Convex_Hull ëŒ€ì‹  Meshë¡œ Shapeì„ ì§€ì •í•˜ëŠ” ë°©ë²•ê³¼ Colliderë¥¼ ì¡°ê¸ˆ ê±°ì¹ ê²Œ ê°€ì ¸ê°€ë˜ Convex_Hullì„ ìœ ì§€í•˜ëŠ” ë°©ë²• 2ê°€ì§€ë¥¼ ì‹œë„í•´ë´¤ìŒ

![](./ì´ë¯¸ì§€/convex_collider.png)

### ë°©ë²•1
- ê·¸ëŸ¼ ê·¸ëƒ¥ meshë¡œ ì§€ì •í•˜ë©´ ë˜ëŠ”ë° ë­ê°€ ë¬¸ì œì¼ê¹Œ?
    - Blenderì˜ Bullet ê¸°ë°˜ Physics Engineì´ 100% CPUê¸°ë°˜ì´ë¼ëŠ” ì ì´ ë¬¸ì œ -> ì—°ì‚° ê³¼ë¶€í•˜
#### mesh ë°©ì‹ì˜ ì¥ì 
- ì§€í˜•ì˜ ì„¸ë¶€ì ì¸ ëª¨ì–‘ í•˜ë‚˜í•˜ë‚˜ ì „ë¶€ ê³„ì‚°í•˜ê¸°ì— í˜„ì‹¤ê³¼ ê°€ì¥ ê°€ê¹Œìš´ ë°©ì‹ì˜ ì‹œë®¬ë ˆì´ì…˜ì´ë¼ê³  ë³¼ ìˆ˜ ìˆìŒ
- ë¶„í™”êµ¬ë‚˜ í˜‘ê³¡ ì§€í˜•ì˜ ë‚´ë¶€ ë˜í•œ ë¬¸ì œì—†ì´ ì˜ ì£¼í–‰í•¨

#### mesh ë°©ì‹ì˜ ë‹¨ì 
- CPUë¡œ ìˆ˜ì²œ ê°œì§œë¦¬ mesh colliderì— ëŒ€í•´ ì¶©ëŒ,ê´€ì„±,íšŒì „,ë¯¸ë„ëŸ¬ì§ ë“±ì„ ë§¤ í”„ë ˆì„ ì‹œí‚¤ë‹¤ë³´ë‹ˆ ê³¼ë¶€í•˜ë¡œ íŠ•ê¸°ëŠ” ì¼ì´ ì¦ìŒ
- íŠ•ê¸°ì§€ ì•ŠëŠ”ë‹¤ê³  í•´ë„ í”„ë ˆì„ì´ 3~5ì‚¬ì´ë¡œ ë§¤ìš° ë‚®ìŒ
- GPUë¡œ ëŒë¦´ ë°©ì•ˆì„ ê°•êµ¬í•´ ë´¤ìœ¼ë‚˜ ì°¾ì§€ ëª» í–ˆìŒ
    - Blender ìì²´ ë¬¼ë¦¬ì—”ì§„ì˜ í•œê³„ë¡œ ë³´ì„

ì˜ìƒ3

#### mesh ë°©ì‹ì˜ ë‹¨ì ì„ í•´ê²°í•  ë°©ì•ˆ(cache bake ë°©ì‹)
- blenderì—ì„  ì„¼ì„œë¥¼ ì´ìš©í•œ ë°ì´í„° íšë“ì´ ëª©ì ì´ë¯€ë¡œ ì£¼í–‰ ì‹œë®¬ë ˆì´ì…˜ì€ ì‹¤ì‹œê°„ì´ ì•„ë‹ˆë”ë¼ë„ ë³´ê¸° ë¶ˆí¸í•˜ê¸° ì•Šê²Œ ë‚˜ì˜¤ë©´ ê´œì°®ì„ ê²ƒì´ë¼ê³  íŒë‹¨í•˜ì˜€ìŒ
#### ì–´ë–¤ ì‹ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ì´ ì²˜ë¦¬ë˜ëŠ”ê°€
- ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ì˜ 1í”„ë ˆì„ ê²°ê³¼ë¥¼ Cacheì— ì„ì‹œ ì €ì¥í•˜ê³  ì´ë¥¼ RAM ìºì‹œ ë²„í¼ì— ê¸°ë¡ (ì´ ê³¼ì •ì„ ë°˜ë³µ) 
- ì§€ì •ëœ íƒ€ì„ ìŠ¤í…ì´ ì™„ë£Œë˜ë©´ Bakeë¥¼ í†µí•´ RAMì˜ ìºì‹œë¥¼ ë””ìŠ¤í¬ì— ì €ì¥

![](./ì´ë¯¸ì§€/cache_bake.png)

ì˜ìƒ1
- ìœ„ ë°©ì‹ìœ¼ë¡œ ì¬ìƒí•œ ì‹œë®¬ë ˆì´ì…˜

### ë°©ì‹2(ë°˜ë“œì‹œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—°ì‚°ì´ ì²˜ë¦¬ë˜ì–´ì•¼ í•œë‹¤ë©´?)
- Meshê°€ ì•„ë‹Œ Convex_Hullì„ ìœ ì§€í•˜ë©° ì‹¤ì‹œê°„ìœ¼ë¡œ ì—°ì‚° ë¶€ë‹´ì—†ì´ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” ë°©ì‹
    - ë‹¤ë§Œ ì œì•½ì¡°ê±´ì´ ë¶™ê²Œ ë¨
#### Convex_Hull ë°©ì‹ì˜ ì¥ì 
- ì—°ì‚°ì´ ëŒ€í­ ê°ì†Œí•˜ë‹¤ë³´ë‹ˆ blenderê°€ íŠ•ê¸¸ ì¼ì´ ì—†ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ì¾Œì í•œ ì‹œë®¬ë ˆì´ì…˜ì´ ê°€ëŠ¥
- ë„ë¡œê°™ì€ ì™„ë§Œí•œ ì§€í˜•ì—ì„  meshì™€ í° ì°¨ì´ì—†ì´ ë¶€ë“œëŸ½ê²Œ ì‹œë®¬ë ˆì´ì…˜ë¨
#### Convex_Hull ë°©ì‹ì˜ ë‹¨ì 
- í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ì§€í˜•ê³¼ ê°™ì´ ìš¸í‰ë¶ˆí‰í•œ ë©´ì´ ë§ê³  ì›€í‘¹ íŒ¨ì—¬ ìˆë‹¤ë©´ ìë™ì°¨ì˜ ì›€ì§ì„ì´ ë¶€ìì—°ìŠ¤ëŸ¬ì›€
    - ë‹¨ì ì´ 1ê°€ì§€ì´ì§€ë§Œ ì‚¬ì‹¤ ì´ í•˜ë‚˜ê°€ ë§¤ìš° í¬ë‹¤ê³  ë³¼ ìˆ˜ ìˆìŒ

ì˜ìƒ4
- ì´ˆë°˜ì²˜ëŸ¼ ì™„ë§Œí•œ ì§€í˜•ì€ ì˜ ì£¼í–‰í•˜ì§€ë§Œ ë’¤ë¡œ ê°ˆ ìˆ˜ë¡ Colliderê°€ ì„¸ë°€í•˜ì§€ ëª» í•´ ìë™ì°¨ê°€ ê³µì¤‘ì— ë– ì„œ ê°€ëŠ” ëª¨ìŠµ

# blednerì—ì„œ ë°ì´í„°ì…‹ ë½‘ì•„ë‚´ê¸°
- ì´ì „ì— ì„¤ëª…í•œ Bakeë¥¼ ì´ìš©í•´ ì°¨ëŸ‰ì˜ ì›€ì§ì„ì„ ë¯¸ë¦¬ ì €ì¥í•´ë‘ê³  blender ë‚´ë¶€ì—ì„œ íŒŒì´ì¬ ì½”ë“œë¥¼ í†µí•´ ë°ì´í„° ìˆ˜ì§‘

ë°ì´í„° ìˆ˜ì§‘ìš© ì˜ìƒ
csv
- ìœ„ ì˜ìƒìœ¼ë¡œë¶€í„° ì–»ì–´ë‚¸ csv íŒŒì¼

### 1. frame
- ì‹œë®¬ë ˆì´ì…˜ í”„ë ˆì„ ë²ˆí˜¸
- 1~250ê¹Œì§€ì˜ ìŠ¤í…ìœ¼ë¡œ ë‚˜ëˆ ì„œ ê° ìŠ¤í…ë³„ ë°ì´í„°ë¥¼ ì €ì¥í•œ ê²ƒ
### 2. time_sec
- ê·¸ í”„ë ˆì„ì´ ì‹œë®¬ë ˆì´ì…˜ìƒì—ì„œ ëª‡ì´ˆëŒ€ì— í•´ë‹¹í•˜ëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚¸ ê²ƒ
 
```text
frame=1 -> 0.000000ì´ˆ
frame=2 -> 0.041667ì´ˆ
frame=250 -> 10.375ì´ˆ
```

### pos_x, pos_y, pos_z
- ìë™ì°¨(ì •í™•íˆëŠ” ì°¨ì˜ ëª¸í†µ)ì˜ ì›”ë“œ ì¢Œí‘œ(Blenderì—ì„œì˜ 1unit = 1më¡œ í•´ì„)
- ì´ˆë°˜ë¶€ì˜ ì¢Œí‘œ
```text
frame 1:  x= 2.2592  y=4.0838  z=1.6751
frame 2:  x= 2.2592  y=4.0850  z=1.6662
frame 5:  x= 2.2592  y=4.0958  z=1.5369
```
- í›„ë°˜ë¶€ì˜ ì¢Œí‘œ
```text
frame 246: x=-36.2109 y=-5.2376 z=9.2633
frame 250: x=-36.3084 y=-4.1236 z=9.3721
```
- xê°€ -36ê·¼ì²˜ë¡œ ê°”ê³  yê°€ 4ì—ì„œ -5ë¶€ê·¼ìœ¼ë¡œ ë°”ë€œ
- ì¦‰ 10ì´ˆ ë™ì•ˆ ì „ì§„/ì»¤ë¸Œë¥¼ í•œ ê²ƒìœ¼ë¡œ ì¶”ì • ê°€ëŠ¥
- zê°€ ì˜¬ë¼ê°„ ê²ƒìœ¼ë¡œ ë³´ì•„ ì–¸ë• ê²½ì‚¬ë¥¼ íƒ€ê³  ì˜¬ë¼ê°”ìŒì„ ì¶”ì • ê°€ëŠ¥
### roll/pitch/yaw
- roll : ì°¨ê°€ ì¢Œìš°ë¡œ ê¸°ìš¸ì–´ì§„ ì •ë„
- pitch: ì°¨ê°€ ì•ë’¤ë¡œ ìˆ™ì´ê±°ë‚˜ ë“¤ë¦° ì •ë„
- yaw: ì°¨ê°€ ì–´ëŠ ë°©í–¥ì„ ë°”ë¼ë³´ê³  ìˆëŠ”ì§€


```text
frame 1: roll=-0.000000, pitch=0.000000, yaw=0.000000
frame 5: roll=-0.033072, pitch=0.000037, yaw=0.000383

frame 246: roll=-0.108899 pitch=-0.245443 yaw=-2.927466
frame 250: roll=-0.128399 pitch=-0.266984 yaw=-2.987396
```

- yawì˜ ë³€í™”ê°€ -3ì •ë„ -> 170ë„ ì´ìƒ íšŒì „í–ˆìŒì„ ì˜ë¯¸(ê±°ì˜ ìœ í„´)
### speed_m_s
- ì´ì „ í”„ë ˆì„ì˜ ìœ„ì¹˜ì™€ ì´ë²ˆ í”„ë ˆì„ì˜ ìœ„ì¹˜ ì°¨ì´ë¥¼ ì´ìš©í•´ì„œ êµ¬í•œ ì†ë ¥ì˜ ê·¼ì‚¿ê°’(m/s)
```text
frame 1: 0.000000
frame 2: 0.215368
frame 3: 0.628825
frame 4: 1.039813
frame 5: 1.445218

frame 246: 6.880745
frame 247: 6.800613
frame 248: 6.776288
frame 249: 6.741632
frame 250: 6.651986
```
- í›„ë°˜ì—ëŠ” ì•½ 6.7 ~ 6.9 m/s ì •ë„ë¡œ ì´ë™
    - km/hë¡œ í™˜ì‚°í•˜ë©´ 24.48km/h

### front_distance_m 
- ì°¨ëŸ‰ ì•ìª½ 50mì´ë‚´ì— ìˆëŠ” ì¥ì• ë¬¼ ê°ì§€ ë° ìˆë‹¤ë©´ ëª‡mì•ì— ìˆëŠ”ì§€

### front_hit_object
- ê·¸ ì•ìª½ì— ìˆë˜ ë¬¼ì²´ê°€ ë¬´ì—‡ì¸ì§€ë¥¼ ì˜ë¯¸

```text
17.753327    BiomeTerrain
18.078477    BiomeTerrain
...
(ë¹ˆì¹¸)
...
19.302382    BiomeTerrain
15.793562    BiomeTerrain
...
6.717324     BiomeTerrain
...
35.629141    BiomeTerrain
...
23.687044    BiomeTerrain
21.611309    BiomeTerrain
...
6.928413     BiomeTerrain
```
- BiomeTerrain: ì—°êµ¬ì‹¤ ìƒì„±ê¸°ë¡œ ìƒì„±í•œ ì§€í˜•
- ê±°ë¦¬ê°€ ì ì  ì¤„ì–´ë“ ë‹¤ëŠ” ì˜ë¯¸ëŠ” ì˜¤ë¥´ë§‰ê¸¸ë¡œ ì„œì„œíˆ ë‹¤ê°€ê°€ê³  ìˆë‹¤ëŠ” ì˜ë¯¸
- ì–¸ë• ìœ„ë¡œ ì˜¬ë¼ì˜¤ë©´ ë‹¤ì‹œ ì°¨ëŸ‰ ì•ì— ì•„ë¬´ê²ƒë„ ì—†ê¸°ì— ë°ì´í„° ì¹¸ì´ ë¹„ì–´ì ¸ìˆëŠ” ëª¨ìŠµ


```python
import bpy
import mathutils
import csv
import os

########################################
# ğŸ”§ ì‚¬ìš©ì ë§ì¶¤ ì„¤ì •
CAR_NAME   = "Object_5"          # ì°¨ì²´ ì˜¤ë¸Œì íŠ¸ ì´ë¦„ 
CAM_NAME   = "FrontCam"          # ì „ë°© ì¹´ë©”ë¼ ì˜¤ë¸Œì íŠ¸ ì´ë¦„ 
FRAME_START = 1                  # ì‹œì‘ í”„ë ˆì„
FRAME_END   = 250                # ë í”„ë ˆì„ 
FPS = bpy.context.scene.render.fps  # ì”¬ì˜ Frame Rate ì‚¬ìš© (ì˜ˆ: 24/30 ë“±)
BASE_PATH = r"C:\Users\CEY\Desktop"    # ì €ì¥ ê²½ë¡œ
IMG_DIR   = os.path.join(BASE_PATH, "frames")  # ì´ë¯¸ì§€ ì €ì¥ í´ë”
CSV_PATH  = os.path.join(BASE_PATH, "sensor_log.csv")
########################################

# í´ë” ì—†ìœ¼ë©´ ë§Œë“¤ê¸°
os.makedirs(IMG_DIR, exist_ok=True)

scene = bpy.context.scene
car_obj = bpy.data.objects[CAR_NAME]
cam_obj = bpy.data.objects[CAM_NAME]

prev_pos = None

# CSV ì—´ê¸°
with open(CSV_PATH, mode="w", newline="", encoding="utf-8") as f:
    writer = csv.writer(f)

    # CSV í—¤ë” (hit ëœ ì˜¤ë¸Œì íŠ¸ ì´ë¦„ê¹Œì§€ ê¸°ë¡)
    writer.writerow([
        "frame",
        "time_sec",
        "pos_x", "pos_y", "pos_z",
        "roll", "pitch", "yaw",
        "speed_m_s",
        "front_distance_m",
        "front_hit_object"
    ])

    # í”„ë ˆì„ ë£¨í”„
    for frame in range(FRAME_START, FRAME_END + 1):
        # 1) í•´ë‹¹ í”„ë ˆì„ìœ¼ë¡œ ì´ë™
        scene.frame_set(frame)

        # 2) ì‹œê°„(ì´ˆ) ê³„ì‚° (frame_startë¥¼ 0ì´ˆë¡œ ë§ì¶¤)
        t_sec = (frame - FRAME_START) / FPS

        # 3) ì°¨ì²´ ìœ„ì¹˜/íšŒì „ (ì›”ë“œ ê¸°ì¤€)
        mat_world = car_obj.matrix_world
        pos = mat_world.translation              # Vector(x,y,z)
        rot_euler = mat_world.to_euler("XYZ")     # roll, pitch, yaw (ë¼ë””ì•ˆ)

        # 4) ì†ë„ ì¶”ì • (ì „ í”„ë ˆì„ ëŒ€ë¹„ ìœ„ì¹˜ ë³€í™” / Î”t)
        if prev_pos is None:
            speed = 0.0
        else:
            delta = pos - prev_pos
            dist = delta.length      # ì´ë™ ê±°ë¦¬ (m ê°€ì •)
            dt = 1.0 / FPS
            speed = dist / dt        # m/s
        prev_pos = pos.copy()

        # 5) "ì „ë°©" ê±°ë¦¬ì„¼ì„œ (ê°„ì´ ë¼ì´ë‹¤)
        #    - forward_local: ì°¨ì˜ 'ì•ì„ í–¥í•˜ëŠ” ë‹¨ìœ„ë°©í–¥'
        #      ì—¬ê¸°ì„œëŠ” ì°¨ ë¡œì»¬ -Yê°€ ì „ë°©ì´ë¼ê³  ê°€ì •
        forward_local_dir = mathutils.Vector((0.0, -1.0, 0.0))

        #    - ì„¼ì„œì˜ ì‹¤ì œ ìœ„ì¹˜(ì¶œë°œì )ë¥¼ ì°¨ì²´ ë¡œì»¬ ì¢Œí‘œë¡œ ì§€ì •
        #      (ì°¨ ì¤‘ì‹¬ì—ì„œ ì•ìœ¼ë¡œ 3m ì •ë„ ì­‰ ëº€ ìœ„ì¹˜, ë†’ì´ 1m ì •ë„)
        #      ì´ ê°’ì€ ë„¤ ì°¨ëŸ‰ ìŠ¤ì¼€ì¼ì— ë”°ë¼ ë” í¬ê²Œ/ì‘ê²Œ ì¡°ì ˆ ê°€ëŠ¥
        sensor_origin_local = mathutils.Vector((0.0, -3.0, 1.0))

        #    ë¡œì»¬ -> ì›”ë“œ ë³€í™˜
        sensor_origin_world = mat_world @ sensor_origin_local
        forward_world_dir = (mat_world.to_quaternion() @ forward_local_dir).normalized()

        max_distance = 50.0  # ë ˆì´ìºìŠ¤íŠ¸ ìµœëŒ€ íƒì§€ ê±°ë¦¬ (m)

        # Blender 4.xì—ì„œëŠ” depsgraph í•„ìš”
        depsgraph = bpy.context.evaluated_depsgraph_get()

        hit, hit_loc, hit_normal, face_index, hit_obj, hit_matrix = scene.ray_cast(
            depsgraph,
            sensor_origin_world,   # ë ˆì´ ì‹œì‘ì 
            forward_world_dir,     # ë ˆì´ ë°©í–¥
            distance=max_distance
        )

        if hit:
            front_dist = (hit_loc - sensor_origin_world).length
            hit_name = hit_obj.name if hit_obj else ""
        else:
            front_dist = None
            hit_name = ""

        # 6) ì¹´ë©”ë¼ì—ì„œ í˜„ì¬ í”„ë ˆì„ ì´ë¯¸ì§€ë¥¼ ë Œë”í•´ì„œ ì €ì¥
        scene.camera = cam_obj

        #    ì €ì¥ íŒŒì¼ ê²½ë¡œ ì„¸íŒ…
        img_name = f"frame_{frame:04d}.png"
        img_fullpath = os.path.join(IMG_DIR, img_name)

        #    Blender ë Œë” ì¶œë ¥ ê²½ë¡œ ì§€ì •
        scene.render.filepath = img_fullpath

        bpy.ops.render.render(write_still=True)

        # 7) CSV ê¸°ë¡
        writer.writerow([
            frame,
            f"{t_sec:.6f}",
            f"{pos.x:.6f}", f"{pos.y:.6f}", f"{pos.z:.6f}",
            f"{rot_euler.x:.6f}", f"{rot_euler.y:.6f}", f"{rot_euler.z:.6f}",
            f"{speed:.6f}",
            "" if front_dist is None else f"{front_dist:.6f}",
            hit_name
        ])

print("ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!")
print("CSV:", CSV_PATH)
print("ì´ë¯¸ì§€ í´ë”:", IMG_DIR)

```
