# ëª¨ì…˜ ìº¡ì²˜ ê¸°ë°˜ í•™ìŠµ
- ì‹¤ì œ ì‚¬ëŒ/ë¡œë´‡ì˜ ë°±í”Œë¦½ ë™ì‘ì„ ìº¡ì²˜í•œ ì• ë‹ˆë©”ì´ì…˜ ë°ì´í„°ë¥¼ ë ˆí¼ëŸ°ìŠ¤ë¡œ ì‚¼ëŠ” ë°©ì‹
- ë³´ìƒ í•¨ìˆ˜ì— "í˜„ì¬ ê´€ì ˆ ìƒíƒœ vs ë ˆí¼ëŸ°ìŠ¤ í¬ì¦ˆ" ë¥¼ ë„£ì–´ì„œ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë”°ë¼ í•˜ë„ë¡ í•™ìŠµ
- DeepMind, Berkeley ë“±ì—ì„œ ì“°ëŠ” ëª¨ì…˜ í´ë¦¬í•‘ ë°ì´í„°ì…‹ì´ ëŒ€í‘œì 
- ë°±í”Œë¦½ì˜ ê²½ìš° ì›ë³¸ ì• ë‹ˆë©”ì´ì…˜ íŒŒì¼ì´ í”„ë¡œì íŠ¸ ì•ˆì— ì—†ìŒ
# ê°•í™”í•™ìŠµ ê¸°ë°˜ ìê¸° ìƒì„±
## ë³´ìƒ
```python
# ì •ì˜ëœ ë³´ìƒì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜ë“¤
# ëª©í‘œí•œ ì„ ì†ë„(x,y)ì™€ ì‹¤ì œ ì„ ì†ë„ì˜ ì°¨ì´ë¥¼ ì¤„ì¼ìˆ˜ë¡ ë³´ìƒ
def _reward_tracking_lin_vel(self):
    # (ëª©í‘œ ì†ë„ ëª…ë ¹ - ì‹¤ì œ ëª¸í†µ ì„ ì†ë„)ë¥¼ ê³„ì‚°í›„ ì œê³±í•œ ê°’ì„ lin_vel_errorì— ëŒ€ì…
        lin_vel_error = torch.sum(torch.square(self.commands[:, :2] - self.base_lin_vel[:, :2]), dim=1)
        # ì˜¤ì°¨ê°€ ì‘ì„ ìˆ˜ë¡ 1ë¡œ ì˜¤ì°¨ê°€ í´ìˆ˜ë¡ 0ì— ê°€ê¹Œì›Œì§, ì¦‰ ì˜¤ì°¨ê°€ ì‘ì„ ìˆ˜ë¡ ë³´ìƒì´ ì»¤ì§
        return torch.exp(-lin_vel_error / self.reward_cfg["tracking_sigma"])
# ëª©í‘œ ê°ì†ë„(íšŒì „ì†ë„)ì™€ ì‹¤ì œ ê°ì†ë„ì˜ ì°¨ì´ë¥¼ ì¤„ì´ë©´ ë³´ìƒ
    def _reward_tracking_ang_vel(self):
        # (ëª©í‘œ ê°ì†ë„ - ì‹¤ì œ ê°ì†ë„)ì˜ ì˜ ì œê³±ì„ ang_vel_errorì— ëŒ€ì…
        ang_vel_error = torch.square(self.commands[:, 2] - self.base_ang_vel[:, 2])
        # í•´ë‹¹ ê°’ì´ ì‘ì„ ìˆ˜ë¡ ë³´ìƒ í¼
        return torch.exp(-ang_vel_error / self.reward_cfg["tracking_sigma"])
# ëª¸í†µì´ ìœ„/ì•„ë˜ë¡œ íŠ€ëŠ” ì†ë„(zì¶• ì„ ì†ë„)ë¥¼ ìµœì†Œí™” ì‹œí‚¤ê¸°
    def _reward_lin_vel_z(self):
        # zì¶• ì†ë„ì˜ ì œê³±ì„ ê³„ì‚° í›„ ê·¸ ê°’ì´ í¬ë©´ ì°¨í›„ ìŒìˆ˜ ê°€ì¤‘ì¹˜ë¥¼ ê³±í•´ íŒ¨ë„í‹° ë¶€ì—¬
        return torch.square(self.base_lin_vel[:, 2])
# ì—°ì†ëœ ìŠ¤í…ì—ì„œ actionì´ í¬ê²Œ ë³€í•˜ì§€ ì•Šë„ë¡ í•˜ëŠ” í•¨ìˆ˜
    def _reward_action_rate(self):
        # (í˜„ì¬ ì•¡ì…˜ - ì§€ë‚œ ì•¡ì…˜)ì˜ ì œê³±ì„ ê³„ì‚° ì´ê²ƒë„ ë§ˆì°¬ê°€ì§€ë¡œ ì°¨í›„ ìŒìˆ˜ ê°€ì¤‘ì¹˜ë¡œ ë¶€ì—¬
        return torch.sum(torch.square(self.last_actions - self.actions), dim=1)
# ê¸°ë³¸ ìì„¸(default pose)ì—ì„œ ë„ˆë¬´ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ í•˜ëŠ” í•¨ìˆ˜
    def _reward_similar_to_default(self):
        # (í˜„ì¬ ê´€ì ˆê° - ê¸°ë³¸ ê´€ì ˆê°)ì˜ ì ˆëŒ“ê°’ì„ í•©ì‚°, ë§ˆì°¬ê°€ì§€ë¡œ í´ìˆ˜ë¡ íŒ¨ë„í‹°
        return torch.sum(torch.abs(self.dof_pos - self.default_dof_pos), dim=1)
# ëª¸í†µì˜ ë†’ì´ê°€ ëª©í‘œ ë†’ì´ì—ì„œ ë²—ì–´ë‚˜ì§€ ì•Šê²Œ í•˜ëŠ” í•¨ìˆ˜
    def _reward_base_height(self):
        # (í˜„ì¬ base zì¢Œí‘œ - ëª©í‘œ ë†’ì´)ì˜ ì œê³± ê³„ì‚° í›„ í´ìˆ˜ë¡ íŒ¨ë„í‹°
        return torch.square(self.base_pos[:, 2] - self.reward_cfg["base_height_target"])
```

```python
# ê° ë³´ìƒ í•¨ìˆ˜ì—ì„œ ë¦¬í„´ëœ ê°’ì— ì •í•´ì§„ ê°€ì¤‘ì¹˜ë¥¼ ê³±í•´ í•©ì‚°í•˜ì—¬ ìµœì¢… ë³´ìƒì´ ê²°ì •ë˜ëŠ” êµ¬ì¡°(í¬ë©´ ì¢‹ì§€ ì•Šì€ ê°’ë“¤ì—ëŠ” ìŒìˆ˜ ê°€ì¤‘ì¹˜ê°€ ë¶€ì—¬ëìŒì„ ì•Œ ìˆ˜ ìˆìŒ)
total_reward = (
    +1.0 * _reward_tracking_lin_vel() +
    +0.2 * _reward_tracking_ang_vel() +
    -1.0 * _reward_lin_vel_z() +
    -0.005 * _reward_action_rate() +
    -0.1 * _reward_similar_to_default() +
    -50.0 * _reward_base_height()
)
```
- ì‹œë®¬ë ˆì´í„°ëŠ” ë§¤ íƒ€ì„ìŠ¤íƒ­(step())ì—ì„œ í™˜ê²½ ìƒíƒœë¥¼ ê°±ì‹ í•˜ê³ , ìœ„ì—ì„œ ë§í•œ ê° ë³´ìƒí•¨ìˆ˜ë“¤ì„ í˜¸ì¶œ, ê·¸ ê²°ê³¼ í•©ì‚°ëœ total_reward ê°’ì´ ë‚˜ì˜´
- ì´ total_reward ê°’ì€ ë‹¨ìˆœ ì ìˆ˜ê°€ ì•„ë‹ˆë¼ ê°•í™”í•™ìŠµ ì•Œê³ ë¦¬ì¦˜ì˜ ì…ë ¥ ì‹ í˜¸ë¡œ ì“°ì„
## ê°•í™”í•™ìŠµì˜ ì „ë°˜ì ì¸ ë£¨í”„
1. PPO(Proximal Policy Optimization) ë„¤íŠ¸ì›Œí¬ê°€ í˜„ì¬ ìƒíƒœ(obs)ë¥¼ ì…ë ¥ë°›ì•„ í˜„ì¬ ë¡œë´‡ì˜ actionì„ ì¶œë ¥
2. ê·¸ actionì„ ì‹œë®¬ë ˆì´í„°ì— ì ìš© -> ë¡œë´‡ì´ ì›€ì§ì„
3. ì‹œë®¬ë ˆì´í„°ëŠ” ìƒˆë¡œìš´ ìƒíƒœ(new_obs)ì™€ í•¨ê»˜ total_rewardë¥¼ ë¦¬í„´
4. ì•Œê³ ë¦¬ì¦˜ì€ (obs,action,reward,next_obs) íŠœí”Œì„ ê¸°ë¡í•˜ê³ , ë‚˜ì¤‘ì— ì´ trajectoryë“¤ì„ ëª¨ì•„ ì •ì±… íŒŒë¼ë¯¸í„°ë¥¼ ì—…ë°ì´íŠ¸ í•¨
## ê·¸ë˜ì„œ ì´ rewardê°€ ì •í™•íˆ ì–´ë–»ê²Œ ì‹ ê²½ë§ì— ì ìš©ë˜ëŠ”ê°€
1. Ï€Î¸â€‹(aâˆ£s)
    - s: í˜„ì¬ ìƒíƒœ (ì˜ˆ: ì†ë„, ìì„¸, ê´€ì ˆê°)
    - a: í–‰ë™ (ì˜ˆ: ëª¨í„° í† í¬ ê°’)
    - Î¸: ì‹ ê²½ë§ì˜ ê°€ì¤‘ì¹˜
- ì¦‰ ì´ ìƒíƒœì—ì„œ í–‰ë™AëŠ” 30%, í–‰ë™ BëŠ” 70% ì´ëŸ°ì‹ìœ¼ë¡œ ë¶„í¬ë¥¼ ë½‘ì• ëƒ„
2. Atâ€‹=Rtâ€‹+Î³V(st+1â€‹)âˆ’V(stâ€‹)
    - AtëŠ” í–‰ë™ì„ í†µí•´ ë“¤ì–´ì˜¨ ë³´ìƒì„ ëˆ„ì í•˜ê±°ë‚˜ ë³´ì •í•´ì„œ "ì´ í–‰ë™ì´ ì–¼ë§ˆë‚˜ ì¢‹ì€ê°€"ë¥¼ ê³„ì‚°í•œ ê²ƒ
    - ex) ì•ìœ¼ë¡œ ì˜ ê±¸ìœ¼ë©´ +1, ì“°ëŸ¬ì§€ë©´ -1
    - Rt: ì¦‰ì‹œ ë³´ìƒ(total_reward)
    - V(s): í˜„ì¬ ìƒíƒœì—ì„œì˜ ê¸°ëŒ€ ë³´ìƒ
    - ğ›¾: ë¯¸ë˜ ë³´ìƒì„ ì–¼ë§ˆë‚˜ ê³ ë ¤í• ì§€
- ê²°ë¡ : Atê°€ 0ë³´ë‹¤ í¬ë©´ ì¢‹ì€ í–‰ë™, Aê°€ ì‘ê±°ë‚˜ ìŒìˆ˜ë©´ ë‚˜ìœí–‰ë™ì´ ë¨
3. L(Î¸)=âˆ’Etâ€‹[logÏ€Î¸â€‹(atâ€‹âˆ£stâ€‹)â‹…Atâ€‹]
- logÏ€Î¸â€‹(atâ€‹âˆ£stâ€‹): ì‹¤ì œë¡œ ì„ íƒí•œ í–‰ë™ì˜ í™•ë¥  ë¡œê·¸ ê°’
- A: ê·¸ í–‰ë™ì´ ì–¼ë§ˆë‚˜ ì¢‹ì€ì§€(ìœ„ì—ì„œ êµ¬í•œê±°)
- ì¦‰ í•´ë‹¹ í–‰ë™ì´ ì–¼ë§ˆë‚˜ ì¢‹ì€ì§€ë¥¼ ê³ ë ¤í•´ ì •ì±…ì„ ì—…ë°ì´íŠ¸ í•˜ëŠ” ê²ƒ
4. ì‘ë™ ë©”ì»¤ë‹ˆì¦˜
- Lì€ ì†ì‹¤ì„ ì˜ë¯¸ ì¦‰ ì´ë¥¼ ìµœì†Œí™” ì‹œí‚¤ëŠ” ê²ƒì´ ëª©í‘œ
    - At > 0ì´ë©´, Lì„ ì¤„ì´ê¸° ìœ„í•´ log ê°’ì´ ì»¤ì§ ì¦‰ ê·¸ í–‰ë™ì˜ í™•ë¥ ì´ ì˜¬ë¼ê°
    - At < 0ì´ë©´, Lì„ ì¤„ì´ê¸° ìœ„í•´ ë°˜ëŒ€ë¡œ log ê°’ì´ ì‘ì•„ì§ ì¦‰ ê·¸ í–‰ë™ì˜ í™•ë¥ ì´ ì¤„ì–´ë“¦
5. PPOì—ì„œëŠ” ìœ„ ì •ì±…ì—ì„œ ì•ˆì •ì„±ì„ ë”í•œ ë²„ì „
![](./í™”ë©´%20ìº¡ì²˜%202025-09-16%20172025.png)
- í–‰ë™ í™•ë¥ ì´ ë„ˆë¬´ ê¸‰ê²©íˆ ë°”ë€Œì§€ ì•Šë„ë¡ í´ë¦¬í•‘ì„ ë„£ìŒ

## ê·¸ë˜ì„œ ì •ë‹µ(ê¸°ì¤€)ì´ ë˜ëŠ” ê°’ë“¤ì€ ì–´ë””ì— ì •ì˜ê°€ ëëŠ”ê°€?
- train.py ì´ˆê¸°ì— ì •ì˜ë˜ì–´ ìˆìŒ
### ëª©í‘œ ì†ë„(commands)
``` python
command_cfg = {
    "num_commands": 3,
    "lin_vel_x_range": [0.5, 0.5],   # ëª©í‘œ: xì¶• ì†ë„ 0.5 m/s
    "lin_vel_y_range": [0, 0],       # ëª©í‘œ: yì¶• ì†ë„ 0
    "ang_vel_range": [0, 0],         # ëª©í‘œ: yaw ê°ì†ë„ 0
}

```
- ì •ë‹µ: ì•ìœ¼ë¡œ 0.5m/s ì§ì§„, ì˜†, íšŒì „ì€ 0
### ëª©í‘œ ë†’ì´
```python
reward_cfg = {
    "base_height_target": 0.3,   # ëª©í‘œ ëª¸í†µ ë†’ì´ (m)
}

```
- ì •ë‹µ: ëª¸í†µ ë†’ì´ 0.3m ìœ ì§€
### ëª©í‘œ ê´€ì ˆ ìœ„ì¹˜
```python
"default_joint_angles": {
    "FL_thigh_joint": 0.8,
    "FR_thigh_joint": 0.8,
    "RL_thigh_joint": 1.0,
    "RR_thigh_joint": 1.0,
    "FL_calf_joint": -1.5,
    "FR_calf_joint": -1.5,
    "RL_calf_joint": -1.5,
    "RR_calf_joint": -1.5,
    ...
}
```
- ì •ë‹µ: ê´€ì ˆë“¤ì´ ìœ„ ê°’ ê·¼ì²˜ì— ìœ„ì¹˜í•˜ë„ë¡ ìœ ì§€
### + ì•¡ì…˜ ë³€í™” ì¤„ì´ê¸°(ì •ë‹µì´ ë™ì ìœ¼ë¡œ ë³€í•¨)
```python
torch.sum(torch.square(self.last_actions - self.actions), dim=1)
```
- ì •ë‹µ ê°’: ì´ì „ í–‰ë™ê³¼ í¬ê²Œ ë‹¤ë¥´ì§€ ì•Šì€ ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„

# ë°±í”Œë¦½ Go2 ë¡œë´‡ì˜ ì›€ì§ì„ ì›ë¦¬(ìì„¸ ì œì–´)
- single.pt ë‚´ë¶€ êµ¬ì¡°
    - ê°„ë‹¨í•œ MLPêµ¬ì¡°
    - 60(ê´€ì¸¡ê°’)ë§Œí¼ì˜ ì…ë ¥ì„ ë„£ì–´ 7ë‹¨ê³„ë¥¼ ê±°ì³ ìµœì¢… 12ê°œì˜ ì¶œë ¥ì„ ë½‘ì•„ëƒ„
    - ì´ 12ê°œì˜ ê°’ = 12ê°œ ê´€ì ˆì— ì¤„ ì•¡ì…˜ ëª…ë ¹
    - ì´ 12ê°œì˜ ê° ê°’ë“¤ì´ ê·¸ëŒ€ë¡œ env.step(actions)ì— ë“¤ì–´ê°€ì„œ ë‹¤ë¦¬ ê´€ì ˆì´ ì›€ì§ì„
- ì¦‰ ì• ë‹ˆë©”ì´ì…˜ ë°ì´í„°(ê¶¤ì )ì´ ì§ì ‘ì ìœ¼ë¡œ ë“¤ì–´ê°€ ìˆëŠ”ê²Œ ì•„ë‹ˆë¼, ë‰´ëŸ´ë„· íŒŒë¼ë¯¸í„°ê°€ ë“¤ì–´ ìˆì–´ì„œ "í˜„ì¬ ìƒíƒœ -> ë‹¤ìŒ ì•¡ì…˜"ì„ ê³„ì‚°í•˜ëŠ” ì›ë¦¬
## ê´€ì¸¡ê°’
- BackflipEnv.get_observations() ë¶€ë¶„
``` python
self.obs_buf = torch.cat(
    [
        self.base_ang_vel * self.obs_scales["ang_vel"],   # 3
        self.projected_gravity,                           # 3
        (self.dof_pos - self.default_dof_pos) * self.obs_scales["dof_pos"], # 12
        self.dof_vel * self.obs_scales["dof_vel"],        # 12
        self.actions,                                     # 12
        self.last_actions,                                # 12
        torch.sin(phase),                                 # 1
        torch.cos(phase),                                 # 1
        torch.sin(phase / 2),                             # 1
        torch.cos(phase / 2),                             # 1
        torch.sin(phase / 4),                             # 1
        torch.cos(phase / 4),                             # 1
    ],
    axis=-1,
)
```
1. ê¸°ë³¸ ë™ì—­í•™ ìƒíƒœ
    - ëª¸í†µì˜ ê°ì†ë„, ì¤‘ë ¥ ë²¡í„°ê°€ ë¡œë´‡ ì¢Œí‘œê³„ì—ì„œ ì–´ë–»ê²Œ ë³´ì´ëŠ”ì§€
2. ê´€ì ˆ ìƒíƒœ
    - ê´€ì ˆ ìœ„ì¹˜ í¸ì°¨
    - ê´€ì ˆ ì†ë„
3. ì•¡ì…˜ íˆìŠ¤í† ë¦¬
    - í˜„ì¬ ì•¡ì…˜
    - ì§ì „ ì•¡ì…˜
4. ìœ„ìƒ ì¸ì½”ë”©
    - ì‹œê°„ ì§„í–‰ì— ë”°ë¼ ì£¼ê¸°ì ì¸ ì‹ í˜¸ ì œê³µ(ë¦¬ë“¬ê°, í”Œë¦½ íƒ€ì´ë° í•™ìŠµ ê°€ëŠ¥)
- ì¦‰ 60ê°œì˜ ê´€ì¸¡ê°’ì€ ë¡œë´‡ì˜ ë¬¼ë¦¬ ìƒíƒœ(ìì„¸,ì†ë„,ê´€ì ˆ), ì§ì „ ì•¡ì…˜ íˆìŠ¤í† ë¦¬, ê·¸ë¦¬ê³  í˜„ì¬ ë™ì‘ì´ ëª‡ % ì§„í–‰ëëŠ”ì§€ ë‚˜íƒ€ë‚´ëŠ” ìœ„ìƒ ì •ë³´
# ê²°ë¡ 
- ì´ ìƒ˜í”Œì˜ ê²½ìš° ê´€ì ˆ 12ê°œë¥¼ ì œì–´í•˜ëŠ” ê²ƒì´ í•µì‹¬, ë“œë¡ ì˜ ê²½ìš° ëª¨í„°íšŒì „ìˆ˜ì— ë”°ë¥¸ í˜(ì¶”ë ¥), ìœ„ì¹˜/ì†ë„/ìì„¸ë¥¼ ì œì–´í•˜ê¸° ìœ„í•œ ë¬¼ë¦¬ì‹ í’€ê¸° ë“± ë” ë³µì¡í•œ ë©”ì»¤ë‹ˆì¦˜ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ íŒŒì•…ë¨

# backflip ëª¨ë¸ì˜ MLP êµ¬ì¡°
1. Linear
2. ELU
3. Linear
4. ELU
5. Linear
6. ELU
7. Linear(ì¶œë ¥ì¸µ)
- ì¦‰ 4ê°œì˜ Linear ì¸µê³¼ ELU í™œì„±í™” í•¨ìˆ˜ë¥¼ ê°€ì§„ ê¹Šì´ 7ì¸µì§œë¦¬ MLP
## íŒŒë¼ë¯¸í„° ê°œìˆ˜
- single.pt(1ë²ˆ ë°±í”Œë¦½) : 197,004ê°œ
- double.pt(2ë²ˆ ë°±í”Œë¦½) : 197,004ê°œ
## Linear ì™€ ELU
- Linear
    - y=Wx+b
    - ì…ë ¥ ë²¡í„° xë¥¼ ê°€ì¤‘ì¹˜ W,í¸í–¥ bë¡œ ì„ í˜•ë³€í™˜ì‹œì¼œ ì£¼ëŠ” ì¸µ
- ELU
     - ELU(x)=x (x>=0)
     - ELU(x)=a(exp(x)-1)(x<0)
        - ë³´í†µ a = 1
        - í‰ê· ì„ 0 ê·¼ì²˜ë¡œ ëŒì–´ì£¼ì–´ í•™ìŠµ ì•ˆì •ì„±ì— ë„ì›€ì„ ì£¼ëŠ” ë¹„ì„ í˜• ë³€í™˜ì¸µ

## ì¸µë³„ ìƒì„¸(ì…ì¶œë ¥, íŒŒë¼ë¯¸í„° ê³„ì‚°)
1. Linear #1: in=60 â†’ out=512
    - weight shape: (512, 60), bias: (512)
    - params=512 x 60 + 512 =31,232
2. ELU : íŒŒë¼ë¯¸í„° 0
3. Linear #2: in 512 -> out=256
    - weight: (256, 512), bias: (256)
    - params = 256 x 512 + 256 = 131,328
4. ELU #2 íŒŒë¼ë¯¸í„° 0
5. Linear #3: in=256 â†’ out=128
    - weight: (128,256), bias:(256)
    - params=128 x 256 + 128 = 32896
6. ELU #3: íŒŒë¼ë¯¸í„° 0
7. Linear #4 (ì¶œë ¥ì¸µ): in=128 â†’ out=12
    = weight:(12,128), bias:(12)
    - params = 12 x 128 + 12 = 1548
### ì´ íŒŒë¼ë¯¸í„° = 31232 + 131328 + 32896 + 1548 = 197004ê°œ
    - single.pt , double.pt ë‘˜ ë‹¤ íŒŒë¼ë¯¸í„° ê°œìˆ˜ ë™ì¼
